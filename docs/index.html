<!DOCTYPE html>
<html>
  <head>
<!-- <base target="_top" /> -->
    <meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">

    
    <!-- Favicon cl√°sico para navegador -->
<link rel="icon" type="image/png" sizes="32x32" href="https://drive.google.com/uc?export=view&id=1OJ4xzBaMnPOu4xQkOuQe8_dSDdp6eOVw">

 <link rel="manifest" href="./manifest.json">    

<!-- Theme color -->
<meta name="theme-color" content="#4CAF50">

<!-- iOS support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="TiendaControl Pro">

<!-- iOS icons -->
<link rel="apple-touch-icon" sizes="192x192" href="https://drive.google.com/uc?export=view&id=1OHcShz0veYkuOpg3UMbYebHa5UdQvEd5">
<link rel="apple-touch-icon" sizes="512x512" href="https://drive.google.com/uc?export=view&id=1OJ4xzBaMnPOu4xQkOuQe8_dSDdp6eOVw">


    <style>
  html {
    font-size: 16px; /* Base para rem */
  }

  html, body {                        
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }    
      
  body {
    font-family: sans-serif;
    background: linear-gradient(135deg, #f1fcff 0%, #d0ecff 100%);
    margin: 1.25rem;       /* 20px */
    padding: 1.25rem;      /* 20px */
    box-sizing: border-box;
    max-width: 30rem;       /* 480px */
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  h2 {
    text-align: center;
    font-size: 2.4rem;
    margin: 1.25rem 0 1.875rem; /* 20px 0 30px */
    background: linear-gradient(135deg, #4CAF50, #2196F3);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 800;
    text-shadow: 0 0.75rem 0.75rem rgba(0,0,0,0.3); /* 12px */
    letter-spacing: 0.125rem; /* 2px */
    animation: glow 2s ease-in-out infinite alternate;
    position: relative;
  }

  h2::before {
    content: "üõí ";
    font-size: 1.2em;
  }

  @keyframes glow {
    from { text-shadow: 0 0.75rem 0.75rem rgba(76,175,80,0.5); }
    to { text-shadow: 0 0.75rem 1.25rem rgba(33,150,243,0.7); }
  }

  h3 {
    font-size: 2.8125rem; /* 45px */
    text-align: center;
    margin-bottom: 1.25rem; /* 20px */
  }

  button {
    width: 90%;
    padding: 0.500rem; 
    font-size: 1.000rem;
    margin: 0.75rem 0; /* 12px */
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 0.875rem; /* 14px */
    box-shadow: 0 0.25rem 0.375rem rgba(0,0,0,0.2); /* 4px 6px */
  }

  button:hover {
    background-color: #45a049;
  }

  .seccion {
    display: none;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    padding-bottom: 3.75rem; /* 60px */
    box-sizing: border-box;
  }

  input, select {
  padding: 0.5rem;
  font-size: 1rem;
  line-height: 1.2;

  margin-bottom: 1.125rem;

  border: 0.15625rem solid #888;
  border-radius: 0.625rem;

  background-color: #fff;
  box-sizing: border-box;
  transition: border-color .2s;

  appearance: none;
  -webkit-appearance: none;
}

  input:focus, select:focus {
    border-color: #0072f7;
    outline: none;
    box-shadow: 0 0 0.25rem #9cf; /* 4px */
  }

  .volver {
    background-color: #777;
  }

  .mensaje {
    position: sticky;
    top: 0;
    background-color: #fff;
    color: #20b050;
    font-weight: bold;
    font-size: 2.5rem; /* 40px */
    text-align: center;
    margin-top: 0.0625rem; /* 1px */
    padding: 0.5rem 1rem; /* 8px 16px */
    box-shadow: 0 0.125rem 0.3125rem rgba(0,0,0,0.10); /* 2px 5px */
    z-index: 1001;
    border-radius: 0.375rem; /* 6px */
    transition: color 0.2s;
  }

  .label-fecha {
    font-size: 2.6875rem; /* 43px */
    margin-left: 1.375rem; /* 22px */
    color: #555;
  }

  input::placeholder,
  select::placeholder {
    font-size: 2.4375rem; /* 39px */
    color: #555;
    opacity: 1;
  }

  select {
    font-size: 2.6875rem; /* 43px */
  }

  .campo-label {
    font-size: 1.875rem; /* 30px */
    font-weight: 600;
    color: #555;
    margin-top: 0.75rem; /* 12px */
    margin-bottom: 0.375rem; /* 6px */
    display: none;
  }

  .resumen-item {
    width: 90%;
    background: white;
    border-radius: 0.75rem; /* 12px */
    padding: 1.125rem; /* 18px */
    margin-bottom: 1rem; /* 16px */
    box-shadow: 0 0.125rem 0.375rem rgba(0,0,0,0.12); /* 2px 6px */
    text-align: center;
  }

  .resumen-item strong {
    font-size: 1.875rem; /* 30px */
    display: block;
    margin-bottom: 0.5rem; /* 8px */
  }

  .resumen-item div {
    font-size: 2.5rem; /* 40px */
    font-weight: bold;
    color: #20b050;
  }

  #btnStockCritico {
    width: 90%;
    padding: 0.500rem;
    font-size: 1.000rem;
    margin: 0.75rem 0; /* 12px */
    background-color: #f59e0b;
    color: white;
    border: none;
    border-radius: 0.875rem; /* 14px */
    box-shadow: 0 0.25rem 0.375rem rgba(0,0,0,0.2); /* 4px 6px */
  }

  #btnStockCritico:hover {
    background-color: #d97706;
  }

  #listaStockCritico .item-producto {
    background-color: #fff;
    padding: 1.125rem; /* 18px */
    font-size: 2.25rem; /* 36px */
    border-bottom: 0.0625rem solid #ccc; /* 1px */
  }

  #listaStockCritico .agotado {
    color: #b91c1c;
  }

  #listaStockCritico .bajo {
    color: #b45309;
  }

  .banner-critico {
    position: sticky;
    top: 0;
    z-index: 1000;
    width: 100%;
    background-color: #f59e0b;
    color: white;
    font-weight: bold;
    font-size: 0.875rem; /* 14px */
    padding: 0.75rem 2.5rem 0.75rem 1rem; /* 12px 40px 12px 16px */
    display: flex;
    align-items: center;
    box-shadow: 0 0.125rem 0.375rem rgba(0,0,0,0.15);
  }

  .banner-critico span {
    width: 100%;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .cerrar-banner {
    margin-left: auto;
    background: transparent;
    border: none;
    color: white;
    font-size: 1.25rem; /* 20px */
    cursor: pointer;
    padding: 0.125rem; /* 2px */
    width: 1.125rem; /* 18px */
    height: 1.125rem; /* 18px */
    line-height: 1.125rem; /* 18px */
  }

  @media (min-width: 900px) {
    body {
      font-size: 1.25rem; /* 20px */
      max-width: 50rem; /* 800px */
      margin: 2em auto;
    }

    .contenedor-formulario, .tabla, .seccion {
      max-width: 56.25rem; /* 900px */
      margin: 0 auto 2em auto;
    }

    .form-grupo {
      display: flex;
      gap: 1.5rem; /* 24px */
    }
  }
</style>


  </head>

<body onload="cargarProductos(); verificarBanner();">
  
  <!-- BANNER STICKY PARA PRODUCTOS CR√çTICOS -->
  <div id="bannerStockCritico" class="banner-critico" style="display:none;">
    <span id="textoBanner">‚õî 0 productos sin stock ‚ö†Ô∏è 0 con stock bajo</span>
    <button id="cerrarBanner" class="cerrar-banner">‚úñ</button>
  </div>

  <!-- <h2>TiendaDaniel Pro</h2> -->
  <!-- Voy a probar este nuevo nombre a ver c√≥mo luce -->
  <h2>Tienda Daniel PRO - Gesti√≥n Total</h2>

  <button onclick="mostrar('ventas')">üü¢ Vender</button>
  <button onclick="mostrar('compras')">üì• Comprar</button>
  <button onclick="mostrar('resumen')">üìä Resumen</button>
  <button onclick="mostrar('productos')">‚ûï Productos</button>
  <button onclick="mostrar('gastos')">üí∏ Gastos</button>
  <!-- NUEVO BOT√ìN PARA PRODUCTOS CR√çTICOS -->
  <button id="btnStockCritico" onclick="mostrarStockCritico()">
  ‚ö†Ô∏è Productos cr√≠ticos
  </button>

<!-- CONTENEDOR DE LA LISTA (OCULTO POR DEFECTO) -->
  <div id="listaStockCritico" class="lista" style="display:none; margin-top:10px;"></div>

  <!-- üü¢ Secci√≥n: Vender -->
  <div id="ventas" class="seccion">
    <h3>Registrar Venta</h3>

    <!-- Producto -->
    <!-- Buscar producto -->

<input
  type="text"
  id="buscarProducto"
  placeholder="Buscar producto..."
  oninput="filtrarProductos()"
/>

<!-- Lista de resultados -->
<div id="listaProductos" class="lista-productos"></div>


    <!-- Cantidad -->
    <input
      type="number"
      id="cantidadVenta"
      placeholder="Cantidad"
      min="1"
    />

    <!-- Label oculto, se mostrar√° solo al seleccionar producto -->
<div class="campo-label" id="lblPrecioVenta">Precio unitario</div>

<!-- Precio (editable por si var√≠a) -->
<input
  type="number"
  id="precioVenta"
  placeholder="Precio unitario"
  step="0.01"
/>


    <!-- Forma de pago -->
    <select id="formaPago">
      <option value="">Forma de pago</option>
      <option value="Efectivo">Efectivo</option>
      <option value="Transferencia">Transferencia</option>
    </select>

    <!-- Bot√≥n principal -->
    <button onclick="registrarVenta()">Guardar Venta</button>

    <!-- Volver -->
    <button class="volver" onclick="volver()">Volver</button>

    <!-- Mensaje de estado -->
    <div id="msgVenta" class="mensaje"></div>
  </div>


  <!-- üì• Secci√≥n: Comprar -->
<div id="compras" class="seccion">
  <h3>üì• Registrar Compra</h3>
  
  <!-- üî• NUEVO BUSCADOR -->
  <input type="text" id="buscarProductoCompra" placeholder="Buscar producto..." onkeyup="filtrarProductosCompra()">

  <div id="listaProductosCompra" class="lista-productos"></div>
  
  <!-- Proveedor NUEVO -->
  <input type="text" id="proveedorCompra" placeholder="Proveedor (opcional)">
  
  <!-- Cantidad comprada (igual) -->
  <input type="number" id="cantidadCompra" placeholder="Cantidad comprada" min="1">
  
  <!-- Precio de compra (igual) -->
  <input type="number" id="precioCompra" placeholder="Precio compra unitario" step="0.01">
  
  <!-- Tipo compra (igual) -->
  <select id="tipoCompra">
    <option value="">Tipo de compra</option>
    <option value="Contado">Contado</option>
    <option value="Cr√©dito">Cr√©dito</option>
  </select>
  
  <!-- Observaciones (igual) -->
  <input type="text" id="observacionesCompra" placeholder="Observaciones (opcional)">
  
  <!-- Botones (iguales) -->
  <button onclick="registrarCompra()">Guardar Compra</button>
  <button class="volver" onclick="volver()">Volver</button>
  <div id="msgCompra" class="mensaje"></div>
</div>




<!-- üìä Secci√≥n: Resumen -->
<div id="resumen" class="seccion">
  <h3>Resumen del D√≠a</h3>

  <div class="resumen-item">
    <strong>Total Ventas:</strong>
    <div id="resumenTotalVentas">$0.00</div>
  </div>

  <div class="resumen-item">
    <strong>Costo Vendido:</strong>
    <div id="resumenCostoVendido">$0.00</div>
  </div>

  <div class="resumen-item">
    <strong>Ganancia Bruta:</strong>
    <div id="resumenGananciaBruta">$0.00</div>
  </div>

  <div class="resumen-item">
    <strong>Gastos del D√≠a:</strong>
    <div id="resumenGastos">$0.00</div>
  </div>

  <div class="resumen-item">
    <strong>Utilidad Neta:</strong>
    <div id="resumenUtilidadNeta">$0.00</div>
  </div>

  <div class="resumen-item">
    <strong>Operaciones:</strong>
    <div id="resumenOperaciones">0</div>
  </div>

  <button onclick="cargarResumen()">Actualizar Resumen</button>
  <button class="volver" onclick="volver()">Volver</button>
</div>

<!-- ‚ûï Secci√≥n: Productos -->
<div id="productos" class="seccion">
 <h3>üì¶ Buscar o editar producto</h3>

  <input
  type="text"
  id="buscarProductoProducto"
  placeholder="Producto"
  onkeyup="filtrarProductosProducto(); detectarProductoNuevo();"
>


<div id="listaProductosProducto" class="lista"></div>

  <div class="campo-label" id="lblcategoriaProducto">Categor√≠a (ej: Bebidas)</div>
  <input type="text" id="categoriaProducto" placeholder="Categor√≠a (ej: Bebidas)">
 
  <div class="campo-label" id="lblPrecioProducto">Precio de venta</div>
<input type="number" id="precioProducto" placeholder="Precio de venta">

<div class="campo-label" id="lblCostoProducto">Costo unitario</div>
<input type="number" id="costoProducto" placeholder="Costo unitario">

<div class="campo-label" id="lblStockInicial">Stock inicial</div>
<input type="number" id="stockInicial" placeholder="Stock inicial">

<div class="campo-label" id="lblStockMinimo">Stock m√≠nimo</div>
<input type="number" id="stockMinimo" placeholder="Stock m√≠nimo">

  
  <button onclick="guardarProducto()">‚ûï Guardar Producto</button>
  <button class="volver" onclick="volver()">Volver</button>
  <div id="msgProducto" class="mensaje"></div>
</div>

<!-- üí∏ Secci√≥n: Gastos -->
<div id="gastos" class="seccion">
  <h3>üí∏ Registrar Gasto</h3>

  <input type="text" id="tipoGasto" placeholder="Tipo de gasto (ej: Luz, Renta)">
  <input type="text" id="descripcionGasto" placeholder="Descripci√≥n (opcional)">
  <input type="number" id="montoGasto" placeholder="Monto" step="0.01">

  <select id="periodicidadGasto">
    <option value="">Periodicidad</option>
    <option value="√önico">√önico</option>
    <option value="Diario">Diario</option>
    <option value="Semanal">Semanal</option>
    <option value="Mensual">Mensual</option>
  </select>

  <button onclick="guardarGasto()">Guardar Gasto</button>
  <button class="volver" onclick="volver()">Volver</button>

  <div id="msgGasto" class="mensaje"></div>
</div>

<script>

function limpiarBuscadores() {
  // Productos (editar)
  const bp = document.getElementById('buscarProductoProducto');
  const lp = document.getElementById('listaProductosProducto');
  if (bp) bp.value = '';
  if (lp) lp.innerHTML = '';

  // Ventas
  const bv = document.getElementById('buscarProducto');
  const lv = document.getElementById('listaProductos');
  if (bv) bv.value = '';
  if (lv) lv.innerHTML = '';

  // Compras
  const bc = document.getElementById('buscarProductoCompra');
  const lc = document.getElementById('listaProductosCompra');
  if (bc) bc.value = '';
  if (lc) lc.innerHTML = '';

  // Reset selecciones
  productoSeleccionado = null;
  productoSeleccionadoCompra = null;
}


function limpiarEstado() {
  limpiarBuscadores();

  // Ventas
  ['cantidadVenta', 'precioVenta', 'formaPago'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  // Compras
  [
    'proveedorCompra',
    'cantidadCompra',
    'precioCompra',
    'tipoCompra',
    'observacionesCompra'
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  // Productos
  [
    'buscarProductoProducto',
    'categoriaProducto',
    'precioProducto',
    'costoProducto',
    'stockInicial',
    'stockMinimo'
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  // Gastos
  [
    'tipoGasto',
    'descripcionGasto',
    'montoGasto',
    'periodicidadGasto'
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  // Reset variables globales
  productoSeleccionado = null;
  productoSeleccionadoCompra = null;

  // üëá OCULTAR NOMBRES DE CAMPOS AL LIMPIAR
  document.querySelectorAll('.campo-label').forEach(el => {
    el.style.display = 'none';
  });

}


  function volver() {
  document.querySelectorAll('.seccion').forEach(sec => {
    sec.style.display = 'none';
  });
}

/* =====================================================
   üî• CARGA DE PRODUCTOS
   ===================================================== */

function cargarProductos() {
  google.script.run
    .withSuccessHandler(function(data) {
      productos = data;
      document.getElementById('listaProductos').innerHTML = '';
      mostrarBannerStockCritico(); // ‚úÖ ahora s√≠ existe
    })
    .withFailureHandler(function(error) {
      console.error(error);
    })
    .obtenerProductos();
}

 function filtrarProductos() {
  const texto = document.getElementById('buscarProducto').value.toLowerCase();
  const lista = document.getElementById('listaProductos');
  
  lista.innerHTML = '';
  lista.style.display = 'block';  

  if (texto.length < 2) return;

  const resultados = productos.filter(p =>
    p.nombre.toLowerCase().includes(texto)
  );

  resultados.forEach(p => {
    const div = document.createElement('div');
    div.className = 'item-producto';

    // Mostrar precio y stock con colores e iconos
    let textoItem = `${p.nombre} ‚Äî $${p.precio} ‚Äî Stock: ${p.stock}`;

    if (p.stock === 0) {
      textoItem = `${p.nombre} ‚Äî $${p.precio} ‚Äî ‚õî Sin stock`;
      div.style.color = '#b91c1c'; // rojo fuerte
    } else if (p.stock <= p.stockMinimo) {
      textoItem = `${p.nombre} ‚Äî $${p.precio} ‚Äî ‚ö†Ô∏è Stock bajo (${p.stock})`;
      div.style.color = '#b45309'; // naranja oscuro
    } else {
      div.style.color = '#166534'; // verde
    }

    div.textContent = textoItem;

    div.onclick = () => seleccionarProducto(p);
    lista.appendChild(div);
  });
}



function limpiarCamposVenta() {
  // Limpiar inputs de ventas
  ['buscarProducto', 'precioVenta', 'cantidadVenta', 'formaPago'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  // Ocultar label de Precio
  document.getElementById('lblPrecioVenta').style.display = 'none';

  // Reset producto seleccionado
  productoSeleccionado = null;

  // Limpiar lista de resultados del buscador
  const lista = document.getElementById('listaProductos');
  if (lista) lista.innerHTML = '';
}

function seleccionarProducto(producto) {
  // üîπ Limpiar campos antes de llenar los nuevos valores
  limpiarCamposVenta();

  productoSeleccionado = producto;

  const buscador = document.getElementById('buscarProducto');
  const lista = document.getElementById('listaProductos');
  const precioInput = document.getElementById('precioVenta');

  buscador.value = producto.nombre;

  // ‚úÖ LLENAR PRECIO AUTOM√ÅTICAMENTE
  precioInput.value = producto.precio;

  // üëá MOSTRAR LABEL DE PRECIO SOLO AL SELECCIONAR PRODUCTO
  document.getElementById('lblPrecioVenta').style.display = 'block';

  // ‚úÖ OCULTAR LISTA
  lista.innerHTML = '';
  lista.style.display = 'none';

  // üëâ Flujo r√°pido
  document.getElementById('cantidadVenta').focus();
}

// detectar cuando el buscador de ventas se vac√≠a y llamar a limpiarCamposVenta()
document.getElementById('buscarProducto').addEventListener('input', () => {
  const texto = document.getElementById('buscarProducto').value;
  if (texto.length === 0) {
    limpiarCamposVenta(); // limpia todos los campos si el buscador est√° vac√≠o
  }
});



function registrarVenta() {
  if (!productoSeleccionado) {
    alert('Selecciona un producto primero');
    return;
  }
  
  const cantidad = parseInt(document.getElementById('cantidadVenta').value);
  const precio = parseFloat(document.getElementById('precioVenta').value) || productoSeleccionado.precio;
  const formaPago = document.getElementById('formaPago').value;
  
  if (!cantidad || cantidad <= 0) {
  mostrarMensajeVenta('‚ö†Ô∏è Ingresa una cantidad v√°lida');
  return;
}


  if (productoSeleccionado.stock === 0) {
  mostrarMensajeVenta('‚õî No se puede vender: producto sin stock');
  return;
}


if (cantidad > productoSeleccionado.stock) {
  mostrarMensajeVenta(
    `‚ö†Ô∏è Stock insuficiente. Solo hay ${productoSeleccionado.stock} unidades`
  );
  return;
}


  
  if (!formaPago) {
    alert('Selecciona forma de pago');
    return;
  }
  
  // Enviar al backend
  const datos = {
    idProducto: productoSeleccionado.id,
    cantidad: cantidad,
    precio: precio,
    formaPago: formaPago
  };
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      document.getElementById('msgVenta').innerHTML = resultado.mensaje;
document.getElementById('msgVenta').style.display = 'block';
setTimeout(() => {
  document.getElementById('msgVenta').style.display = 'none';
}, 3000);
      // Limpiar todo
      document.getElementById('buscarProducto').value = '';
      document.getElementById('cantidadVenta').value = '';
      document.getElementById('precioVenta').value = '';
      document.getElementById('formaPago').value = '';
      document.getElementById('listaProductos').innerHTML = '';
      productoSeleccionado = null;
      cargarProductos(); // Recargar lista
    })
    .withFailureHandler(function(error) {
      alert('Error: ' + error.message);
    })
    .registrarVenta(datos);
}

function mostrarMensajeVenta(texto, tipo = 'error') {
  const msg = document.getElementById('msgVenta');
  msg.innerHTML = texto;
  msg.style.display = 'block';

  if (tipo === 'error') {
    msg.style.color = '#b00020'; // rojo elegante
  } else {
    msg.style.color = 'green';
  }

  setTimeout(() => {
    msg.style.display = 'none';
  }, 3000);
}


 /* =====================================================
   üî• VARIABLES GLOBALES
   ===================================================== */

let productos = [];
let productosCompra = [];

let productoSeleccionado = null;
let productoSeleccionadoCompra = null;
let productoSeleccionadoProducto = null;


function cargarProductosCompra() {
  google.script.run
    .withSuccessHandler(function(data) {
      productosCompra = data;
      console.log('Productos para compra:', data.length); // Para debug
    })
    .withFailureHandler(function(error) {
      console.error('Error:', error);
    })
    .obtenerProductos();
}


function filtrarProductosCompra() {
  const texto = document.getElementById('buscarProductoCompra').value.toLowerCase();
  const lista = document.getElementById('listaProductosCompra');

  // üßπ Limpiar siempre
  lista.innerHTML = '';

  // ‚ùå Menos de 2 letras ‚Üí ocultar y salir
  if (texto.length < 2) {
    lista.style.display = 'none';
    return;
  }

  const resultados = productosCompra.filter(p =>
    p.nombre.toLowerCase().includes(texto)
  );

  // ‚ùå Sin resultados ‚Üí ocultar
  if (resultados.length === 0) {
    lista.style.display = 'none';
    return;
  }

  // ‚úÖ Mostrar lista
  lista.style.display = 'block';

  resultados.forEach(p => {
    const div = document.createElement('div');
    div.className = 'item-producto';
    div.innerHTML = `${p.nombre} ‚Äî Stock: ${p.stock}`;
    div.onclick = () => seleccionarProductoCompra(p);
    lista.appendChild(div);
  });
}


function seleccionarProductoCompra(producto) {
  productoSeleccionadoCompra = producto;

  document.getElementById('buscarProductoCompra').value = producto.nombre;
  document.getElementById('listaProductosCompra').innerHTML = '';
  document.getElementById('listaProductosCompra').style.display = 'none';
}


function registrarCompra() {
  if (!productoSeleccionadoCompra) {
    mostrarMensaje('msgCompra', '‚ùå Selecciona un producto primero', 'error');
    return;
  }
  
  const cantidad = parseInt(document.getElementById('cantidadCompra').value);
  const precio = parseFloat(document.getElementById('precioCompra').value);
  const tipoCompra = document.getElementById('tipoCompra').value;
  
  if (!cantidad || cantidad <= 0) {
    mostrarMensaje('msgCompra', '‚ùå Ingresa cantidad v√°lida', 'error');
    return;
  }
  if (!precio || precio <= 0) {
    mostrarMensaje('msgCompra', '‚ùå Ingresa precio de compra', 'error');
    return;
  }
  if (!tipoCompra) {
    mostrarMensaje('msgCompra', '‚ùå Selecciona tipo de compra', 'error');
    return;
  }
  
  const datos = {
    idProducto: productoSeleccionadoCompra.id,
    cantidad: cantidad,
    precio: precio,
    proveedor: document.getElementById('proveedorCompra').value,
    tipoCompra: tipoCompra,
    observaciones: document.getElementById('observacionesCompra').value
  };
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      // ‚ùå IGUAL QUE VENTAS (mensaje verde)
      document.getElementById('msgCompra').innerHTML = resultado.mensaje;
      document.getElementById('msgCompra').style.display = 'block';
      setTimeout(() => {
        document.getElementById('msgCompra').style.display = 'none';
      }, 3000);
      
      // Limpiar formulario
      document.getElementById('buscarProductoCompra').value = '';
      document.getElementById('proveedorCompra').value = '';
      document.getElementById('cantidadCompra').value = '';
      document.getElementById('precioCompra').value = '';
      document.getElementById('tipoCompra').value = '';
      document.getElementById('observacionesCompra').value = '';
      document.getElementById('listaProductosCompra').innerHTML = '';
      productoSeleccionadoCompra = null;
      cargarProductosCompra();
    })
    .withFailureHandler(function(error) {
      // ‚ùå IGUAL QUE VENTAS
      alert('Error: ' + error.message);
    })
    .registrarCompra(datos);
}



function mostrar(id) {

// üîí OCULTAR PRODUCTOS CR√çTICOS SI EST√Å ABIERTO
  const listaCriticos = document.getElementById('listaStockCritico');
  if (listaCriticos) {
    listaCriticos.style.display = 'none';
  }

  // Ocultar secciones
  document.querySelectorAll('.seccion').forEach(sec => {
    sec.style.display = 'none';
  });

  // üî• LIMPIAR SIEMPRE
  limpiarEstado();
  if (id === 'productos') {
  productoSeleccionadoProducto = null; // üîπ Paso 1: asegurar que no hay producto seleccionado
}

  // Mostrar secci√≥n
  const seccion = document.getElementById(id);
  if (seccion) {
    seccion.style.display = 'flex';

    setTimeout(() => {
      seccion.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }, 150);

    // Cargas necesarias
    if (id === 'ventas') cargarProductos();
    if (id === 'compras') cargarProductosCompra();
    if (id === 'resumen') cargarResumen();
  }
}



function cargarResumen() {
  google.script.run
    .withSuccessHandler(function(resumen) {
      // Actualizar todos los campos
      document.getElementById('resumenTotalVentas').textContent = '$' + resumen.totalVentas;
      document.getElementById('resumenCostoVendido').textContent = '$' + resumen.costoVendido;
      document.getElementById('resumenGananciaBruta').textContent = '$' + resumen.gananciaBruta;
      document.getElementById('resumenGastos').textContent = '$' + resumen.gastosDia;
      document.getElementById('resumenUtilidadNeta').textContent = '$' + resumen.utilidadNeta;
      document.getElementById('resumenOperaciones').textContent = resumen.operaciones;
    })
    .withFailureHandler(function(error) {
      alert('Error cargando resumen: ' + error.message);
    })
    .cargarResumen();
}

function guardarProducto() {
  const buscador = document.getElementById('buscarProductoProducto');
  const nombre = buscador.value.trim();

  if (!nombre) {
    const msg = document.getElementById('msgProducto');
    msg.innerHTML = '‚ùå Escribe o selecciona un producto';
    msg.style.display = 'block';
    setTimeout(() => { msg.style.display = 'none'; }, 3000);
    return;
  }

  // Verificar si estamos editando o creando
  const editar = productoSeleccionadoProducto !== null;

  const datos = {
    id: editar ? productoSeleccionadoProducto.id : null,
    nombre: nombre,
    categoria: document.getElementById('categoriaProducto').value,
    precio: document.getElementById('precioProducto').value,
    costo: document.getElementById('costoProducto').value,
    stock: document.getElementById('stockInicial').value || 0,
    stockMin: document.getElementById('stockMinimo').value || 0
  };

  google.script.run
    .withSuccessHandler(function(resultado) {
      const msg = document.getElementById('msgProducto');
      msg.innerHTML = resultado.mensaje;
      msg.style.display = 'block';
      setTimeout(() => { msg.style.display = 'none'; }, 3000);

      // Limpiar formulario y buscador
      productoSeleccionadoProducto = null;
      ['nombreProducto', 'categoriaProducto', 'precioProducto', 'costoProducto', 'stockInicial', 'stockMinimo', 'buscarProductoProducto'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      document.getElementById('listaProductosProducto').innerHTML = '';

      // Recargar lista global
      cargarProductos();
    })
    .withFailureHandler(function(error) {
      const msg = document.getElementById('msgProducto');
      msg.innerHTML = '‚ùå Error: ' + error.message;
      msg.style.display = 'block';
      setTimeout(() => { msg.style.display = 'none'; }, 3000);
    })
    .guardarProducto(datos);
}


function filtrarProductosProducto() {
  const texto = document
    .getElementById('buscarProductoProducto')
    .value
    .toLowerCase();

  const lista = document.getElementById('listaProductosProducto');
  lista.innerHTML = '';

  if (texto.length < 2) return;

  const resultados = productos.filter(p =>
    p.nombre.toLowerCase().includes(texto)
  );

  resultados.forEach(p => {
    const div = document.createElement('div');
    div.className = 'item-producto';

    let textoItem = `${p.nombre} ‚Äî Stock: ${p.stock}`;

    if (p.stock === 0) {
      textoItem = `${p.nombre} ‚Äî ‚õî Sin stock`;
      div.style.color = '#ff0000'; // rojo fuerte
    } else if (p.stock <= p.stockMinimo) {
      textoItem = `${p.nombre} ‚Äî ‚ö†Ô∏è Stock bajo (${p.stock})`;
      div.style.color = '#ff9900'; // naranja brillante
    } else {
      div.style.color = '#008000'; // verde intenso
    }

    div.textContent = textoItem;
    div.onclick = () => seleccionarProductoProducto(p);
    lista.appendChild(div);
  });
}




function seleccionarProductoProducto(producto) {
  productoSeleccionadoProducto = producto; // ‚úÖ Guardar producto seleccionado

  console.log(producto);


  // üîç Poner nombre en el buscador
  document.getElementById('buscarProductoProducto').value = producto.nombre;
  document.getElementById('listaProductosProducto').innerHTML = '';

  // ‚úçÔ∏è Llenar campos del formulario
  document.getElementById('categoriaProducto').value = producto.categoria || '';
  document.getElementById('precioProducto').value = producto.precio || '';
  document.getElementById('costoProducto').value = producto.costo || 0;
  
  // ‚úÖ Corregido: mostrar el valor correcto de stock inicial y m√≠nimo
  document.getElementById('stockInicial').value = producto.stock != null ? producto.stock : 0;
  document.getElementById('stockMinimo').value = producto.stockMinimo ?? '';

  // üëá MOSTRAR NOMBRES DE CAMPOS SOLO AL EDITAR
  document.querySelectorAll('.campo-label').forEach(el => {
    el.style.display = 'block';
  });
}


function guardarGasto() {
  const tipo = document.getElementById('tipoGasto').value;
  const monto = document.getElementById('montoGasto').value;

  if (!tipo || !monto || monto <= 0) {
    document.getElementById('msgGasto').innerHTML = '‚ùå Completa tipo y monto v√°lido';
    document.getElementById('msgGasto').style.display = 'block';
    setTimeout(() => document.getElementById('msgGasto').style.display = 'none', 3000);
    return;
  }

  const datos = {
    tipo: tipo,
    descripcion: document.getElementById('descripcionGasto').value,
    monto: monto,
    periodicidad: document.getElementById('periodicidadGasto').value
  };

  google.script.run
    .withSuccessHandler(function(res) {
      document.getElementById('msgGasto').innerHTML = res.mensaje;
      document.getElementById('msgGasto').style.display = 'block';
      setTimeout(() => document.getElementById('msgGasto').style.display = 'none', 3000);

      document.getElementById('tipoGasto').value = '';
      document.getElementById('descripcionGasto').value = '';
      document.getElementById('montoGasto').value = '';
      document.getElementById('periodicidadGasto').value = '';
    })
    .withFailureHandler(err => alert(err.message))
    .registrarGasto(datos);
}


function mostrarSeccion(id) {
  // Ocultar todas las secciones
  document.querySelectorAll('.seccion').forEach(sec => {
    sec.style.display = 'none';
  });

  const seccion = document.getElementById(id);
  if (seccion) {
    seccion.style.display = 'block';

    // ‚¨áÔ∏è Scroll suave (m√≥vil y desktop)
    setTimeout(() => {
      seccion.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }, 150);

    // üì± EXTRA: enfocar primer campo (teclado m√≥vil)
    setTimeout(() => {
      const primerInput = seccion.querySelector('input, select, textarea');
      if (primerInput) primerInput.focus();
    }, 300);
  }
}

function detectarProductoNuevo() {
  const buscador = document.getElementById('buscarProductoProducto');

  // Si hab√≠a un producto seleccionado y el usuario escribe algo distinto
  if (
    productoSeleccionadoProducto &&
    buscador.value.trim() !== productoSeleccionadoProducto.nombre
  ) {
    // üîÑ Limpiar estado de edici√≥n
    productoSeleccionadoProducto = null;

    // Limpiar campos del formulario
    ['categoriaProducto', 'precioProducto', 'costoProducto', 'stockInicial', 'stockMinimo']
      .forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

    // Ocultar etiquetas
    document.querySelectorAll('.campo-label').forEach(el => {
      el.style.display = 'none';
    });
  }
  }

/* =====================================================
   üî• BANNER Y STOCK CR√çTICO (CORREGIDO)
   ===================================================== */

function mostrarStockCritico() {

  // üîí OCULTAR FORMULARIOS ABIERTOS
  document.querySelectorAll('.seccion').forEach(sec => {
    sec.style.display = 'none';
  });

  const contenedor = document.getElementById('listaStockCritico');
  contenedor.innerHTML = '';

  const agotados = productos.filter(p => p.stock === 0);
  const bajos = productos.filter(p => p.stock > 0 && p.stock <= p.stockMinimo);

  agotados.forEach(p => {
    const div = document.createElement('div');
    div.className = 'item-producto agotado';
    div.textContent = `‚õî ${p.nombre} ‚Äî Sin stock`;
    contenedor.appendChild(div);
  });

  bajos.forEach(p => {
    const div = document.createElement('div');
    div.className = 'item-producto bajo';
    div.textContent = `‚ö†Ô∏è ${p.nombre} ‚Äî Stock bajo (${p.stock})`;
    contenedor.appendChild(div);
  });

  contenedor.style.display =
    contenedor.style.display === 'none' ? 'block' : 'none';
}

function mostrarBannerStockCritico() {
  const banner = document.getElementById('bannerStockCritico');
  const texto = document.getElementById('textoBanner');

  if (!banner || !texto) return;

  const agotados = productos.filter(p => p.stock === 0).length;
  const bajos = productos.filter(p => p.stock > 0 && p.stock <= p.stockMinimo).length;

  if (agotados === 0 && bajos === 0) {
    banner.style.display = 'none';
    return;
  }

  texto.textContent = `‚õî ${agotados} productos sin stock ‚ö†Ô∏è ${bajos} con stock bajo`;
  banner.style.display = 'flex';
}

   

/* function verificarBanner() {
  setTimeout(() => {
    mostrarBannerStockCritico();
  }, 1000);
} */

// ‚úÖ A√ëADIDO: cerrar banner manualmente
const btnCerrar = document.getElementById('cerrarBanner');

if (btnCerrar) {
  btnCerrar.addEventListener('click', () => {
    const banner = document.getElementById('bannerStockCritico');
    if (banner) banner.style.display = 'none';
  });
}

 </script>
  </body>
</html>
